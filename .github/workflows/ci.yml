name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

env:
    CARGO_TERM_COLOR: always
    RUSTFLAGS: -Dwarnings

jobs:
    test:
        name: Test (${{ matrix.os }}, ${{ matrix.rust }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
                rust: [stable, beta]
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: ${{ matrix.rust }}
            - name: Run tests
              run: cargo test --all-features --verbose
            - name: Run tests (no default features)
              run: cargo test --no-default-features --verbose

    clippy:
        name: Clippy
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  components: clippy
            - name: Clippy (all features)
              run: cargo clippy --all-features -- -D warnings
            - name: Clippy (no features)
              run: cargo clippy --no-default-features -- -D warnings

    fmt:
        name: Format
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt
            - name: Check formatting
              run: cargo fmt --check

    docs:
        name: Documentation
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - name: Build documentation
              run: cargo doc --no-deps --all-features
              env:
                  RUSTDOCFLAGS: -Dwarnings
            - name: Test doc examples
              run: cargo test --doc --all-features

    wasm:
        name: WASM Build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  targets: wasm32-unknown-unknown
            - name: Build for WASM
              run: cargo build --target wasm32-unknown-unknown --no-default-features

    msrv:
        name: MSRV (1.75)
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: "1.75"
            - name: Check MSRV
              run: cargo check --all-features

    # Ensure no unsafe code
    safety:
        name: Safety Checks
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - name: Check for unsafe code
              run: cargo build --all-features 2>&1 | grep -i "unsafe" && exit 1 || echo "No unsafe code found"

    # Feature combinations
    features:
        name: Feature Matrix
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - name: No features
              run: cargo check --no-default-features
            - name: Only serde
              run: cargo check --no-default-features --features serde
            - name: All features
              run: cargo check --all-features
