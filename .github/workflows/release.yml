name: Release

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:
        inputs:
            tag_name:
                description: "Tag to release (e.g., v0.1.0-pre.1)"
                required: true

permissions:
    contents: write

jobs:
    publish:
        name: Publish to crates.io
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Publish to crates.io
              run: cargo publish --token ${{ secrets.CRATES_IO_TOKEN }}

    release:
        name: Create GitHub Release
        runs-on: ubuntu-latest
        needs: publish
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        steps:
            - uses: actions/checkout@v4

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ inputs.tag_name || github.ref_name }}
                  name: Release ${{ inputs.tag_name || github.ref_name }}
                  body: |
                      ## What's Changed

                      - Check the [CHANGELOG](CHANGELOG.md) for detailed changes
                      - View the [documentation](https://docs.rs/anyfs-backend) for usage examples

                      **Full Changelog**: https://github.com/DK26/anyfs-backend/compare/v0.0.1...${{ github.ref_name }}
                  draft: false
                  prerelease: ${{ contains(github.ref_name, 'pre') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
                  generate_release_notes: true
